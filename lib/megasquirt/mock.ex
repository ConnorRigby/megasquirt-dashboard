defmodule Megasquirt.Mock do
  use GenServer

  @playback [
    %{
      adv: 16.097913316226666,
      afr: 15.183629948196925,
      clt: 240.96373865626828,
      map: 19.440388078108953,
      rpm: 804.6442717223317,
      tps: -0.33281316314772724
    },
    %{
      adv: 15.115497428958705,
      afr: 13.713813850341985,
      clt: 239.62325477113356,
      map: 19.981669014470597,
      rpm: 799.6043522777558,
      tps: 0.5244817912196131
    },
    %{
      adv: 17.582124237529893,
      afr: 16.20122670079395,
      clt: 242.7435868524052,
      map: 19.841539070196784,
      rpm: 800.6201069594672,
      tps: -1.163130471076257
    },
    %{
      adv: 16.81332380908223,
      afr: 13.815029611607617,
      clt: 239.67424584757708,
      map: 20.270114869224624,
      rpm: 802.5039043846868,
      tps: 0.28040318794851415
    },
    %{
      adv: 14.557993672901038,
      afr: 14.619741409180824,
      clt: 239.26624657067407,
      map: 20.05540152753853,
      rpm: 801.0030360585196,
      tps: -1.0521147308310614
    },
    %{adv: 16.0, afr: 14.4, clt: 240.1, map: 20.0, rpm: 803.4, tps: 0.0},
    %{
      adv: 14.928329221198346,
      afr: 13.942272684874098,
      clt: 240.73124901218844,
      map: 20.578686637814055,
      rpm: 795.9347097156583,
      tps: 1.0919301251705928
    },
    %{
      adv: 16.34366796720387,
      afr: 14.70243252991534,
      clt: 240.3687808430547,
      map: 19.28705875933174,
      rpm: 802.61199677342,
      tps: -0.004219299169345936
    },
    %{
      adv: 15.60670982068325,
      afr: 14.63330357721432,
      clt: 241.06721742259646,
      map: 19.199199827257864,
      rpm: 805.3887603125671,
      tps: 0.8129600300854221
    },
    %{
      adv: 16.141379588162103,
      afr: 15.306289761074545,
      clt: 241.34056862837647,
      map: 20.21058225103236,
      rpm: 796.1187272311382,
      tps: -0.853847686569054
    },
    %{
      adv: 15.349040639632186,
      afr: 15.031230470471959,
      clt: 242.88907211854064,
      map: 19.829768746222182,
      rpm: 804.201106020811,
      tps: 0.07788994625368295
    },
    %{
      adv: 16.389148316090175,
      afr: 15.364610260415203,
      clt: 240.4043288087452,
      map: 20.46170667717371,
      rpm: 800.1510800628708,
      tps: -0.5294647561014966
    },
    %{
      adv: 15.226588396901256,
      afr: 15.953102008827814,
      clt: 240.58912155263556,
      map: 19.778931779797563,
      rpm: 801.9331134846253,
      tps: 0.20530065105966067
    },
    %{
      adv: 16.980741081590253,
      afr: 14.864155699774697,
      clt: 239.56428264271952,
      map: 19.365197694857795,
      rpm: 803.5743860323993,
      tps: 0.03687397112170576
    },
    %{
      adv: 16.46652832606298,
      afr: 14.94545625460605,
      clt: 242.77730205341607,
      map: 20.444550007347424,
      rpm: 799.2718160412832,
      tps: 0.3269147718013521
    },
    %{
      adv: 15.019377822335464,
      afr: 14.783946367918354,
      clt: 239.50345347779898,
      map: 20.562570404337805,
      rpm: 800.5514898553926,
      tps: -0.352235284054933
    },
    %{
      adv: 15.612610914931974,
      afr: 13.907519083185997,
      clt: 240.34581936726394,
      map: 19.567941417856865,
      rpm: 811.7492789991006,
      tps: -0.8480158261455856
    },
    %{
      adv: 17.084550762969197,
      afr: 15.3243439352583,
      clt: 240.0484488305066,
      map: 19.868634557333262,
      rpm: 810.0519359949633,
      tps: 1.2673373451934964
    },
    %{
      adv: 16.428480769742038,
      afr: 14.204886505567835,
      clt: 241.21640263841172,
      map: 20.62422480996061,
      rpm: 805.0955341474864,
      tps: 1.8496245914728675
    },
    %{
      adv: 16.296611853700508,
      afr: 15.855837498018303,
      clt: 241.82656406527187,
      map: 20.10128493959479,
      rpm: 795.530645646258,
      tps: -0.3278952389599278
    },
    %{
      adv: 15.573616052769728,
      afr: 14.497632517733235,
      clt: 241.85842552322373,
      map: 22.167001086457535,
      rpm: 800.3864358033721,
      tps: 0.3012126097925161
    },
    %{
      adv: 16.713437315931568,
      afr: 14.759890353814644,
      clt: 241.15726721311557,
      map: 20.63784988514671,
      rpm: 804.0065821593589,
      tps: -0.9102081451731342
    },
    %{
      adv: 17.042063529473236,
      afr: 14.901103330626732,
      clt: 242.3916989957425,
      map: 19.909414471582053,
      rpm: 799.619291434003,
      tps: 0.681368623382888
    },
    %{
      adv: 16.826720657526145,
      afr: 14.760163963736122,
      clt: 241.9880726452606,
      map: 19.017512353591123,
      rpm: 800.1036578314119,
      tps: -0.2641032572158555
    },
    %{adv: 16.0, afr: 14.5, clt: 240.6, map: 20.0, rpm: 810.9, tps: 0.0},
    %{
      adv: 15.680745043956545,
      afr: 15.32970262670359,
      clt: 239.87092587078985,
      map: 19.37027420600249,
      rpm: 802.5136418480337,
      tps: 0.8853216042854799
    },
    %{
      adv: 16.27077983069324,
      afr: 14.369477100568368,
      clt: 241.1669337848715,
      map: 20.927687567200394,
      rpm: 804.1849324598737,
      tps: -1.3147144072511625
    },
    %{
      adv: 16.795385089975955,
      afr: 14.577304965460343,
      clt: 239.8286151460732,
      map: 19.093298656572223,
      rpm: 810.6610767870084,
      tps: 0.6778412361710321
    },
    %{
      adv: 15.721333661575938,
      afr: 13.503483265032811,
      clt: 241.67832283765597,
      map: 18.868734391183402,
      rpm: 811.9257059876825,
      tps: -0.3092187335114782
    },
    %{
      adv: 15.931811215917568,
      afr: 14.015594878416067,
      clt: 242.03151513303825,
      map: 20.321029405135054,
      rpm: 802.8405750602993,
      tps: 0.9734737030486346
    },
    %{
      adv: 16.35617739765352,
      afr: 14.519131625958714,
      clt: 241.97755400380882,
      map: 21.282885149857133,
      rpm: 800.349070802924,
      tps: -0.4771385521482093
    },
    %{
      adv: 15.347610100741228,
      afr: 12.547170084647307,
      clt: 240.6729161529383,
      map: 20.070844662994457,
      rpm: 802.5560666037858,
      tps: -0.13790859569493674
    },
    %{
      adv: 15.705933673723859,
      afr: 14.431719399872206,
      clt: 241.15850530620816,
      map: 20.024856585600524,
      rpm: 801.9991615970022,
      tps: 0.6587040603396035
    },
    %{
      adv: 17.347137901235612,
      afr: 14.792614391168971,
      clt: 242.42378742017237,
      map: 19.138745571039742,
      rpm: 795.9330197780068,
      tps: -2.4189207714212038
    },
    %{
      adv: 16.08219534746897,
      afr: 15.022373209103284,
      clt: 239.75248268452287,
      map: 18.385893984443857,
      rpm: 802.2439293959774,
      tps: 0.77013257514688
    },
    %{
      adv: 14.993491636425729,
      afr: 13.835978151874766,
      clt: 239.6282239780989,
      map: 19.940023526938134,
      rpm: 800.8764277339284,
      tps: -0.311242031328142
    },
    %{
      adv: 15.5427874373414,
      afr: 15.548763365509053,
      clt: 241.64866459999763,
      map: 18.45859696271155,
      rpm: 805.0829253455933,
      tps: 0.5265259123635659
    },
    %{
      adv: 16.032673356018652,
      afr: 15.443481785521637,
      clt: 240.890286726629,
      map: 18.429197967848307,
      rpm: 811.752648331773,
      tps: 0.38844738601174744
    },
    %{
      adv: 17.15227517502714,
      afr: 14.305898792253156,
      clt: 240.33597807858496,
      map: 19.679555570267308,
      rpm: 803.3976928133238,
      tps: 0.6284710114107702
    },
    %{
      adv: 14.975988249704464,
      afr: 14.559510566756959,
      clt: 239.54292166727475,
      map: 20.30359550931359,
      rpm: 801.2251118544048,
      tps: 0.04980294094671822
    },
    %{
      adv: 16.80869146656659,
      afr: 15.512356306883474,
      clt: 242.7296359358711,
      map: 19.12419707683605,
      rpm: 800.3678303080338,
      tps: -0.1707782466953498
    },
    %{
      adv: 15.189167927884851,
      afr: 14.323600313398357,
      clt: 240.75176687556944,
      map: 19.274466969165207,
      rpm: 805.5272541752734,
      tps: -0.8739345619472078
    },
    %{adv: 16.0, afr: 14.9, clt: 240.2, map: 20.0, rpm: 805.6, tps: 0.0},
    %{
      adv: 16.187678066299963,
      afr: 14.977072940297104,
      clt: 240.9887454570348,
      map: 20.39148780437494,
      rpm: 801.5014977276926,
      tps: -0.3791918275131796
    },
    %{adv: 16.0, afr: 14.7, clt: 241.0, map: 20.0, rpm: 795.2, tps: 0.0},
    %{
      adv: 16.621210018653887,
      afr: 15.45075580056572,
      clt: 239.19745595352325,
      map: 19.007093511685383,
      rpm: 803.1461756012003,
      tps: -0.023942694405539755
    },
    %{
      adv: 15.955986942588222,
      afr: 14.78291882164989,
      clt: 239.99701997761872,
      map: 20.02342278464516,
      rpm: 800.0664457295045,
      tps: -1.246369860156134
    },
    %{
      adv: 16.90615903021526,
      afr: 13.740736302477682,
      clt: 242.96526995165104,
      map: 19.431329650842677,
      rpm: 802.9656594250819,
      tps: 1.9477573734954676
    },
    %{
      adv: 15.999614635865909,
      afr: 13.458037376662885,
      clt: 240.439354496111,
      map: 19.308636155056295,
      rpm: 803.395496991151,
      tps: 0.7703854662904431
    },
    %{adv: 16.0, afr: 14.9, clt: 239.5, map: 20.0, rpm: 801.9, tps: 0.0},
    %{
      adv: 16.497103007937053,
      afr: 14.266174775610788,
      clt: 241.54924191168837,
      map: 21.00369826566914,
      rpm: 800.9815107024518,
      tps: -0.998117195596004
    },
    %{
      adv: 16.433911289925412,
      afr: 15.939711553352671,
      clt: 241.12923742783929,
      map: 19.961547039581337,
      rpm: 800.5758017181723,
      tps: -0.605708448852095
    },
    %{
      adv: 16.454200939684565,
      afr: 14.486889767237736,
      clt: 242.68280400128688,
      map: 20.615295350557055,
      rpm: 799.4969555656153,
      tps: -0.13681237598088702
    },
    %{
      adv: 17.501084650857024,
      afr: 13.934605565936563,
      clt: 240.37558805758295,
      map: 20.27984346613685,
      rpm: 803.5895775529359,
      tps: -1.5067771675272432
    },
    %{
      adv: 14.587158182547675,
      afr: 13.605576701873401,
      clt: 241.09625357868939,
      map: 18.88301061912038,
      rpm: 806.25228956878,
      tps: -1.6092365084506803
    },
    %{
      adv: 18.292429829517513,
      afr: 14.031440594225481,
      clt: 241.1948488761673,
      map: 20.37650753851198,
      rpm: 803.88013260726,
      tps: -2.4268977512373726
    },
    %{
      adv: 16.665539738043833,
      afr: 15.19981034900065,
      clt: 242.01235859524564,
      map: 19.24635652047729,
      rpm: 795.0488593286728,
      tps: -1.4642717791194582
    },
    %{adv: 16.0, afr: 14.7, clt: 240.0, map: 20.0, rpm: 800.3, tps: 0.0},
    %{
      adv: 16.16060308974979,
      afr: 13.269833894446128,
      clt: 239.88781141797782,
      map: 19.890485235498236,
      rpm: 803.0783379366435,
      tps: -0.607317583159605
    },
    %{
      adv: 15.478292288823042,
      afr: 14.278230127575576,
      clt: 241.07989128854783,
      map: 19.973246215418158,
      rpm: 795.9543062183282,
      tps: 0.25771095085163687
    },
    %{
      adv: 15.070658800849138,
      afr: 14.410698184321559,
      clt: 241.21314565542113,
      map: 19.499762479605884,
      rpm: 811.7158864317148,
      tps: -0.9769849376360593
    },
    %{adv: 16.0, afr: 14.6, clt: 241.0, map: 21.0, rpm: 801.3, tps: 0.0},
    %{
      adv: 15.991576083549353,
      afr: 14.866790007247253,
      clt: 240.34865308570176,
      map: 19.318768716385865,
      rpm: 811.3738412858016,
      tps: -0.044477318669150945
    },
    %{adv: 16.0, afr: 14.8, clt: 242.0, map: 20.1, rpm: 799.5, tps: 0.0},
    %{
      adv: 15.336097966798835,
      afr: 14.403780733728809,
      clt: 240.1709186049154,
      map: 19.81135050421084,
      rpm: 801.0729307372447,
      tps: -0.3609886395002574
    },
    %{adv: 16.0, afr: 14.3, clt: 242.0, map: 20.0, rpm: 803.7, tps: 0.0},
    %{
      adv: 16.336506302512365,
      afr: 15.66038183375563,
      clt: 242.00424165216253,
      map: 20.587379821148684,
      rpm: 800.0930294382363,
      tps: 1.0261178820771937
    },
    %{
      adv: 15.018037873859937,
      afr: 15.346163982748179,
      clt: 239.19358771047112,
      map: 19.80598737873478,
      rpm: 801.9667684523374,
      tps: -0.21009956452081058
    },
    %{
      adv: 15.986831896298254,
      afr: 15.651929913981633,
      clt: 241.7527903019099,
      map: 19.302606524553354,
      rpm: 795.1758500001838,
      tps: -0.824173765552612
    },
    %{
      adv: 15.35137259338914,
      afr: 14.00327936214425,
      clt: 240.9344535497838,
      map: 20.10722727788778,
      rpm: 802.5053033732348,
      tps: 0.6512906795135501
    },
    %{
      adv: 15.928656456344486,
      afr: 13.775062042105528,
      clt: 241.876062424689,
      map: 21.987457860979955,
      rpm: 801.1703225439117,
      tps: -1.6412088058802297
    },
    %{
      adv: 16.455536608618107,
      afr: 14.755862764966391,
      clt: 240.95686094448308,
      map: 20.1596632301225,
      rpm: 804.6223950205023,
      tps: 0.8653730262783595
    }
  ]

  def start_link(args, opts \\ [name: __MODULE__]) do
    GenServer.start_link(__MODULE__, args, opts)
  end

  def init(args) do
    registry = Keyword.fetch!(args, :registry)
    send(self(), {:play, @playback})
    {:ok, %{registry: registry}}
  end

  def handle_info({:play, [value | rest]}, state) do
    dispatch(state, value)
    Process.send_after(self(), {:play, rest}, 100)
    {:noreply, state}
  end

  def handle_info({:play, []}, state) do
    send(self(), {:play, @playback})
    {:noreply, state}
  end

  def dispatch(state, data) do
    Registry.dispatch(state.registry, :dispatch, fn entries ->
      for {pid, nil} <- entries, do: send(pid, {:realtime, data})
    end)
  end
end
